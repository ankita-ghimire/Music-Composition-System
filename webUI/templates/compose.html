{% extends 'base.html' %}
{% block title %}Compose - Music AI{% endblock %}

{% block content %}
<div class="row g-4">
  <!-- Left Column: Controls -->
  <div class="col-lg-4">
    <div class="card p-3">
      <h4 class="card-title text-center mb-4">Composition Controls</h4>
      <form id="compose-form">
        <!-- Basic Controls -->
        <h6 class="form-section-title">Basics</h6>
        <div class="mb-3">
          <label for="key" class="form-label">Key</label>
          <select class="form-select" id="key" name="key_name">
            <option value="C">C</option><option value="D">D</option><option value="E">E</option>
            <option value="F">F</option><option value="G">G</option><option value="A">A</option><option value="B">B</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="mode" class="form-label">Mode</label>
          <select class="form-select" id="mode" name="mode">
            <option value="major">Major</option><option value="minor">Minor</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="num_bars" class="form-label">Number of Bars</label>
          <input type="number" class="form-control" id="num_bars" name="num_bars" value="4" min="1" max="16">
        </div>
        
        <hr class="my-4">

        <!-- Advanced Controls -->
        <h6 class="form-section-title">Advanced</h6>
        <div class="mb-3">
            <label for="tempo" class="form-label">Tempo (BPM)</label>
            <input type="range" class="form-range" id="tempo" name="tempo" min="60" max="180" value="120" oninput="this.nextElementSibling.value = this.value">
            <output class="d-block text-center">120</output>
        </div>

        <div class="d-grid gap-2">
          <button type="submit" class="btn btn-primary btn-lg mt-3" id="generate-btn">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <i class="fas fa-wand-magic-sparkles"></i> Generate
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Right Column: Results -->
  <div class="col-lg-8">
    <div class="card results-panel">
        <div id="results-area" class="card-body text-center">
            <i class="fas fa-fingerprint welcome-icon"></i>
            <h5 class="mt-3">Ready to Create?</h5>
            <p class="text-muted">Adjust the controls and click 'Generate'.</p>
        </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('compose-form').addEventListener('submit', async function(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const generateBtn = document.getElementById('generate-btn');
    const spinner = generateBtn.querySelector('.spinner-border');
    const resultsArea = document.getElementById('results-area');
    
    generateBtn.disabled = true;
    spinner.classList.remove('d-none');
    resultsArea.innerHTML = `
        <div class="d-flex justify-content-center align-items-center h-100">
            <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <span class="ms-3">Generating your masterpiece...</span>
        </div>`;

    try {
        // IMPORTANT: This now points to the dedicated action route from server.py
        const response = await fetch('/compose-action', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();

        if (result.success && result.midi_url) {
            resultsArea.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-check-circle success-icon"></i>
                    <h4 class="mt-3">Composition Complete!</h4>
                    <p>Your MIDI file is ready for download.</p>
                    <a href="${result.midi_url}" class="btn btn-success" download>
                        <i class="fas fa-download"></i> Download MIDI
                    </a>
                    <p class="text-muted small mt-3">Hint: Open the downloaded file in MuseScore for sheet music.</p>
                </div>
            `;
        } else {
            throw new Error(result.error || 'An unknown error occurred.');
        }

    } catch (error) {
        resultsArea.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> Could not generate music.</div>`;
    } finally {
        generateBtn.disabled = false;
        spinner.classList.add('d-none');
    }
});
</script>
{% endblock %}